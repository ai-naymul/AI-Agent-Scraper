<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI-Agent-Scraper</title>
<style>
 body{font-family:Arial;margin:0;padding:0;display:flex;height:100vh}
 #left{flex:0 0 350px;padding:20px;border-right:1px solid #ddd}
 #right{flex:1;display:flex;flex-direction:column}
 #screens{flex:1;overflow:auto;background:#000}
 img{width:100%;height:auto}
 #token-stats {
   margin-top: 20px;
   padding: 10px;
   background: #f5f5f5;
   border-radius: 5px;
   font-size: 12px;
 }
 .token-row {
   display: flex;
   justify-content: space-between;
   margin: 2px 0;
 }
 .token-label {
   font-weight: bold;
 }
 #decisions-log {
   margin-top: 10px;
   max-height: 200px;
   overflow-y: auto;
   background: #fafafa;
   border: 1px solid #ddd;
   padding: 5px;
   font-size: 11px;
 }
 .decision-entry {
   margin: 5px 0;
   padding: 5px;
   background: white;
   border-left: 3px solid #007acc;
 }
</style>
</head>
<body>
<div id="left">
  <h3>Prompt</h3>
  <textarea id="prompt" rows="8" style="width:100%;">go to https://www.ycombinator.com/jobs and save open roles as txt</textarea>
  <label>Format:
    <select id="fmt">
      <option>txt</option><option>md</option><option>json</option><option>html</option>
    </select>
  </label><br/>
  <label><input type="checkbox" id="headless" checked/> Headless</label><br/><br/>
  <button onclick="run()">Run</button>
  <div id="status"></div>
  <a id="download" style="display:none;">Download result</a>
  
  <div id="token-stats" style="display:none;">
    <h4 style="margin-top:0;">Token Usage</h4>
    <div class="token-row">
      <span class="token-label">Total Tokens:</span>
      <span id="total-tokens">0</span>
    </div>
    <div class="token-row">
      <span class="token-label">Prompt Tokens:</span>
      <span id="prompt-tokens">0</span>
    </div>
    <div class="token-row">
      <span class="token-label">Response Tokens:</span>
      <span id="response-tokens">0</span>
    </div>
    <div class="token-row">
      <span class="token-label">API Calls:</span>
      <span id="api-calls">0</span>
    </div>
  </div>
  
  <div id="decisions-log" style="display:none;">
    <h4 style="margin-top:0;">Recent Decisions</h4>
    <div id="decisions-content"></div>
  </div>
</div>
<div id="right">
  <div id="screens"></div>
</div>

<script>
let totalTokens = 0;
let totalPromptTokens = 0;
let totalResponseTokens = 0;
let apiCallCount = 0;

function updateTokenStats(tokenUsage) {
  if (tokenUsage) {
    totalTokens += tokenUsage.total_tokens || 0;
    totalPromptTokens += tokenUsage.prompt_tokens || 0;
    totalResponseTokens += tokenUsage.response_tokens || 0;
    apiCallCount++;
    
    document.getElementById('total-tokens').textContent = totalTokens.toLocaleString();
    document.getElementById('prompt-tokens').textContent = totalPromptTokens.toLocaleString();
    document.getElementById('response-tokens').textContent = totalResponseTokens.toLocaleString();
    document.getElementById('api-calls').textContent = apiCallCount;
    document.getElementById('token-stats').style.display = 'block';
  }
}

function addDecisionToLog(decision) {
  const decisionsContent = document.getElementById('decisions-content');
  const entry = document.createElement('div');
  entry.className = 'decision-entry';
  
  let actionText = `Action: ${decision.action}`;
  if (decision.selector) actionText += `\nSelector: ${decision.selector}`;
  if (decision.text) actionText += `\nText: ${decision.text}`;
  if (decision.url) actionText += `\nURL: ${decision.url}`;
  
  entry.textContent = actionText;
  decisionsContent.insertBefore(entry, decisionsContent.firstChild);
  
  // Keep only last 10 decisions
  while (decisionsContent.children.length > 10) {
    decisionsContent.removeChild(decisionsContent.lastChild);
  }
  
  document.getElementById('decisions-log').style.display = 'block';
}

function resetStats() {
  totalTokens = 0;
  totalPromptTokens = 0;
  totalResponseTokens = 0;
  apiCallCount = 0;
  document.getElementById('token-stats').style.display = 'none';
  document.getElementById('decisions-log').style.display = 'none';
  document.getElementById('decisions-content').innerHTML = '';
}

async function run() {
  document.getElementById("screens").innerHTML="";
  resetStats();
  
  const body = {
    prompt: document.getElementById("prompt").value,
    format: document.getElementById("fmt").value,
    headless: document.getElementById("headless").checked
  };
  const res = await fetch("/job", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  const {job_id} = await res.json();
  document.getElementById("status").textContent="Job "+job_id;
  const sock = new WebSocket(`ws://${location.host}/ws/${job_id}`);
  sock.onmessage = ev => {
    const msg = JSON.parse(ev.data);
    if (msg.screenshot){
      const img = new Image();
      img.src="data:image/png;base64,"+msg.screenshot;
      document.getElementById("screens").prepend(img);
    }
    if (msg.decision) {
      addDecisionToLog(msg.decision);
      if (msg.decision.token_usage) {
        updateTokenStats(msg.decision.token_usage);
      }
    }
    if (msg.status==="saved"){
      const link = document.getElementById("download");
      link.href=`/download/${job_id}`;
      link.textContent="Download";
      link.style.display="block";
    }
  }
}
</script>
</body>
</html>